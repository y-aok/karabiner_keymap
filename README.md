# My Karabiner Mappings

The mappings are expected to be applied on 109 keyboard devices recognized as 101 keyboard.

## Guides

### Generate Config File (JSON)

`karabiner.json` can be generated by the following:

```shell
cd jsonnet
jsonnet main.jsonnet -o karabiner.json
```

### Supported Devices

The following devices are supported at the moment:

- Apple Macbook builtin keyboard (109)
- Topre HHKB Professional JP

In order to add support for other devices, the following would be required:

- `jsonnet/profiles/default/device_id/<device_name>.libsonnet` with `product_id` and `vendor_id`
- `jsonnet/profiles/default/devices_<device_name>.libsonnet` with `simple_modifications` configured specifically for the device

## Policies

* gather the keys in the center of home position
* place modifier keys so that they can be held by thumbs
* avoid having requirements to use multiple modifier keys at once
    * shift key is not expected to be used on non-origin layers
    * let specific keys mapped for the case where we need to use modifier keys + symbols configured on non-origin layers (e.g. `<C-\>`)

## Expected Result

Layer 0: (based on HHKB JP)
```
,-----------------------------------------------------------.
|   |  1|  2|  3|  4|  5|  6|  7|  8|  9|  0|  -|  =| xx|Bsp|
|-----------------------------------------------------------|
|  Esu|  Q|  W|  E|  R|  T|   |  Y|  U|  I|  O|  P|Kna|     |
|------------------------------------------------------` Ent|
|EscCmd|  A|  S|  D|  F|  G|   |  H|  J|  K|  L|  ;|  '|    |
|-----------------------------------------------------------|
|    Esu|  Z|  X|  C|  V|  B|   |  N|  M|  ,|  .|  /|Kna|   |
|    Sft|   |   |   |   |   |   |   |   |   |   |   |Cmd|Cmd|
|-----------------------------------------------------------|
|   ||   |   |Esc|Tab|   Spc   |Ent|Del|   |   ||Lft|Dwn|Rgh|
|Cmd||   |Alt|Cmd|Ly1|   Ctl   |Sft|Ly2|Alt|   ||Lft|Dwn|Rgh|
`-----------------------------------------------------------'
```

Layer 1: Characters
```
,-----------------------------------------------------------.
|Pwr| F1| F2| F3| F4| F5| F6| F7| F8| F9|F10|F11|F12|Ins|Del|
|-----------------------------------------------------------|
|     |  !|  @|  #|  $|  %|   |  ^|  &|  *|  (|  )|Esc|     |
|------------------------------------------------------`    |
|   Esu|  +|  =|Bsp|  -|  ~|   |Lft|Dwn| Up|Rgh|  _|Kna|    |
|-----------------------------------------------------------|
|       |   |   |   |Esc|   |   |  {|  }|  [|  ]|   |   |   |
|-----------------------------------------------------------|
|   ||   |   |   |   | Cmd+Spc |   |   |   |   ||   |   |   |
`-----------------------------------------------------------'
```

Layer 2: Numbers
```
,-----------------------------------------------------------.
|Pwr| F1| F2| F3| F4| F5| F6| F7| F8| F9|F10|F11|F12|Ins|Del|
|-----------------------------------------------------------|
|     |   |  `|  ||  \|   |   |   |   |C-\|Esc|   |   |     |
|------------------------------------------------------`    |
|      |  1|  2|  3|  4|  5|   |  6|  7|  8|  9|  0|   |    |
|-----------------------------------------------------------|
|       |   |   |   |Esc|   |   |   |   |   |   |   |   |   |
|-----------------------------------------------------------|
|   ||   |   |   |   |         |   |   |   |   ||   |   |   |
`-----------------------------------------------------------'
```

## Notes

### multi-function for modifiers key

expected to be configured under `jsonnet/profiles/xxx/complex_mods/multi_function_keys.jsonnet`

```profiles.complex_modifications.rules
{
    "description": "Eisuu -> oneshot: tab, else: LCommand",
    "manipulators": [
        {
            "from": {
                "key_code": "japanese_eisuu",
                "modifiers": {
                    "optional": [
                        "any"
                    ]
                }
            },
            "to": [
                {
                    "key_code": "left_command"
                }
            ],
            "to_if_alone": [
                {
                    "key_code": "tab"
                }
            ],
            "type": "basic"
        }
    ]
},
```

### simulate "layer" using karabiner

currently `modifiers.mandatory` is used for this instead of simultaneous features for the sake of simplicity.


```profiles.complex_modifications.rules
{
  "description": "CapsLock layer",
  "manipulators": [
    {
        "type": "basic",
        "from": {
            "key_code": "q",
            "modifiers": {
                "mandatory": ["caps_lock"]
            }
        },
        "to": [
            {
                "key_code": "1",
                "modifiers": ["left_shift"]
            }
        ]
    }
  ]
}
```

#### ref

- [modifier](https://karabiner-elements.pqrs.org/docs/json/complex-modifications-manipulator-definition/from/modifiers/)
- [simultaneous (1)](https://karabiner-elements.pqrs.org/docs/json/complex-modifications-manipulator-definition/from/simultaneous/)
- [simultaneous (2)](https://gist.github.com/ljosa/df7a08953a050f8b49997840095d132d)


### "temporary" mappings

some keys are soft-mapped "twice" in order to leave some modifier keys unmapped for complicated configurations:

* "left_command" is mapped to "f18" by `simple_modifications`, and then "f18" is configured for complex_modifications
* switch to "layer1" by fn
* switch to "layer2" by right_option

## Appendix

### keycodes for the keys on 109 keyboard when recognized as 101 keyboard

* `- / =`   ... "hyphen"
* `~ / ^`   ... "equal_sign"
* `yen / |` ... "international3"
* `@ / '`   ... "open_bracket"
* `[ / {`   ... "close_bracket"
* `+ / ;`   ... "semicolon"
* `* / :`   ... "quote"
* `] / }`   ... "non_us_pound" on hhkb, "backslash" on mac
* `_ / \`   ... "international1"

### possible scenario for using simultaneous features for multi layer

expected to be configured under `jsonnet/profiles/xxx/complex_mods/multi_layers.jsonnet`

* order in simultaneous must be modifier_key -> non-modifier_key
* `key_down_order` must be `strict`
* `detect_key_down_uninterruptedly` must be `false`
* `key_up_order` should be `strict_inverse`
    * but do NOT specify for "backspace" in order to make it work without key_up
* `key_up_when` should be `all`
* set layer_var=1 in `to` section, while setting layer_var=0 in `to_after_key_up`
* set keymap under `"conditions": layer_var=1` argument


```profiles.complex_modifications.rules
{
    "description": "SpaceFN layer",
    "manipulators": [
        {
            "from": {
                "modifiers": {
                    "optional": [
                        "any"
                    ]
                },
                "simultaneous": [
                    {
                        "key_code": "spacebar"
                    },
                    {
                        "key_code": "l"
                    }
                ],
                "simultaneous_options": {
                    "key_down_order": "strict",
                    "key_up_order": "strict_inverse",
                    "to_after_key_up": [
                        {
                            "set_variable": {
                                "name": "SpaceFN",
                                "value": 0
                            }
                        }
                    ]
                }
            },
            "parameters": {
                "basic.simultaneous_threshold_milliseconds": 500
            },
            "to": [
                {
                    "set_variable": {
                        "name": "SpaceFN",
                        "value": 1
                    }
                },
                {
                    "key_code": "right_arrow"
                }
            ],
            "type": "basic"
        },
        ...,
        {
            "conditions": [
                {
                    "name": "SpaceFN",
                    "type": "variable_if",
                    "value": 1
                }
            ],
            "from": {
                "key_code": "l",
                "modifiers": {
                    "optional": [
                        "any"
                    ]
                }
            },
            "to": [
                {
                    "key_code": "right_arrow"
                }
            ],
            "type": "basic"
        },
```
